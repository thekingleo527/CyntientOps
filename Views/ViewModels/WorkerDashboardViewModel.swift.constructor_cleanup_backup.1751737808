//
//  WorkerDashboardViewModel.swift
//  FrancoSphere
//

import SwiftUI
import Combine

@MainActor
class WorkerDashboardViewModel: ObservableObject {
    
    // Published Properties with closure-based initialization
    @Published var assignedBuildings: [NamedCoordinate] = []
    @Published var todaysTasks: [ContextualTask] = []
    @Published var isDataLoaded = false
    @Published var dataHealthStatus: DataHealthStatus = .unknown
    @Published var errorMessage: String?
    @Published var isRefreshing = false
    @Published var weatherImpact: WeatherImpact?
    
    @Published var progress: TaskProgress = {
        TaskProgress(completed: 0, total: 0, remaining: 0, percentage: 0, overdueTasks: 0)
    }()
    
    // Dependencies
    private let workerService: WorkerService
    private let taskService: TaskService
    private let contextEngine: WorkerContextEngine
    private var cancellables = Set<AnyCancellable>()
    
    init(workerService: WorkerService = WorkerService.shared,
         taskService: TaskService = TaskService.shared,
         contextEngine: WorkerContextEngine = WorkerContextEngine.shared) {
        
        self.workerService = workerService
        self.taskService = taskService
        self.contextEngine = contextEngine
        
        setupReactiveBindings()
    }
    
    func loadDashboardData() async {
        let workerId = NewAuthManager.shared.workerId
        guard !workerId.isEmpty else {
            errorMessage = "No worker ID available"
            return
        }
        
        isDataLoaded = false
        errorMessage = nil
        
        do {
            let buildings = try await workerService.getAssignedBuildings(workerId)
            let tasks = try await taskService.getTasks(for: workerId, date: Date())
            let taskProgress = try await taskService.getTaskProgress(for: workerId)
            
            assignedBuildings = buildings
            todaysTasks = tasks
            progress = taskProgress
            
            dataHealthStatus = assessDataHealth()
            isDataLoaded = true
            
        } catch {
            errorMessage = "Failed to load dashboard: \(error.localizedDescription)"
        }
    }
    
    func refreshData() async {
        isRefreshing = true
        await loadDashboardData()
        isRefreshing = false
    }
    
    private func assessDataHealth() -> DataHealthStatus {
        var issues: [String] = []
        
        if assignedBuildings.isEmpty { issues.append("No buildings assigned") }
        if todaysTasks.isEmpty { issues.append("No tasks scheduled") }
        
        if issues.isEmpty { return .healthy }
        else if issues.count <= 2 { return .warning(issues) }
        else { return .critical(issues) }
    }
    
    private func setupReactiveBindings() {
        // Setup bindings without complex constructors
    }
}
