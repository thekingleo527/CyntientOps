//
//  TodayTasksViewModel.swift
//  FrancoSphere
//

import SwiftUI
import Combine

@MainActor
class TodayTasksViewModel: ObservableObject {
    @Published var tasks: [ContextualTask] = []
    @Published var completedTasks: [ContextualTask] = []
    @Published var pendingTasks: [ContextualTask] = []
    @Published var isLoading = false
    
    // Use nil initialization to avoid constructor issues
    @Published var progress: TaskProgress?
    @Published var taskTrends: TaskTrends?
    @Published var performanceMetrics: PerformanceMetrics?
    @Published var streakData: StreakData?
    
    private let taskService = TaskService.shared
    private let contextEngine = WorkerContextEngine.shared
    private var cancellables = Set<AnyCancellable>()
    
    init() {
        setupBindings()
    }
    
    func loadTodaysTasks() async {
        isLoading = true
        
        let workerId = NewAuthManager.shared.workerId
        guard !workerId.isEmpty else {
            isLoading = false
            return
        }
        
        do {
            let todaysTasks = try await taskService.getTasks(for: workerId, date: Date())
            
            await MainActor.run {
                self.tasks = todaysTasks
                self.completedTasks = todaysTasks.filter { $0.status == "completed" }
                self.pendingTasks = todaysTasks.filter { $0.status == "pending" }
            }
            
        } catch {
            print("Error loading tasks: \(error)")
        }
        
        isLoading = false
    }
    
    private func setupBindings() {
        // Minimal setup without complex constructors
    }
}
